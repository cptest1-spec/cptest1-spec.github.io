<html><head><base href="https://ad.js">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Airflow Diagram Editor</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            overflow: hidden;
        }
        #diagram {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 100%;
            height: calc(100vh - 200px);
            overflow: hidden;
        }
        .node {
            cursor: grab;
        }
        .node:active {
            cursor: grabbing;
        }
        .link {
            fill: none;
            stroke-width: 1.5px;
            cursor: pointer;
        }
        .tooltip {
            position: absolute;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
        }
        #controls, #editForm, #linkForm, #removeNodeForm, #removeLinkForm, #editLinkForm {
            margin-bottom: 20px;
        }
        button, input, select {
            margin-right: 10px;
            padding: 5px 10px;
            font-size: 14px;
        }
        #statusBar {
            background-color: #e0e0e0;
            padding: 5px;
            border-radius: 5px;
            margin-top: 10px;
        }
        #nodeList, #consoleWindow, #nodeInfoWindow, #nodesListWindow, #historyWindow, #jsonSchemaWindow, #editNodeJsonWindow, #linkListWindow, #linkEditWindow {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        .nodeListItem, .linkListItem {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .nodeListItem:hover, .linkListItem:hover {
            background-color: #f0f0f0;
        }
        .nodeColorPreview, .linkColorPreview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        #nodeEditWindow {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 20px;
            display: none;
            z-index: 1001;
        }
        #nodeEditWindow input, #nodeEditWindow textarea, #nodeEditWindow select {
            width: 100%;
            margin-bottom: 10px;
        }
        .closeButton {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #999;
        }
        .closeButton:hover {
            color: #333;
        }
        #docs {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
        }
        #docs:hover {
            background-color: #45a049;
        }
        #consoleInput {
            width: 100%;
            margin-bottom: 10px;
        }
        #nodeInfoContent, #nodesListContent, #historyContent {
            white-space: pre-wrap;
            font-family: monospace;
        }
        #miniMap {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 200px;
            height: 150px;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #searchBar {
            display: flex;
            margin-bottom: 10px;
        }
        #searchInput {
            flex-grow: 1;
            margin-right: 10px;
        }
        #jsonInput, #jsonOutput, #editNodeJsonContent {
            width: 100%;
            height: 200px;
            margin-bottom: 10px;
        }
        #currentNodeName {
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="searchBar">
        <input type="text" id="searchInput" placeholder="Search for node">
        <button id="searchButton">Search</button>
    </div>
    <div id="controls">
        <button id="addNode">Add Node</button>
        <button id="removeNode">Remove Node</button>
        <button id="addLink">Add Link</button>
        <button id="removeLink">Remove Link</button>
        <button id="resetLayout">Reset Layout</button>
        <button id="resetView">Reset View</button>
        <button id="toggleLabels">Toggle Labels</button>
        <button id="showNodeList">List Nodes</button>
        <button id="showLinkList">List Links</button>
        <button id="exportImage">Export Image</button>
        <button id="openConsole">Console</button>
        <button id="showHistory">Show History</button>
        <button id="toggleMiniMap">Toggle Mini-Map</button>
    </div>
    <div id="editForm" style="display: none;">
        <input type="text" id="nodeId" placeholder="Node ID">
        <select id="nodeGroup">
            <option value="1">Group 1</option>
            <option value="2">Group 2</option>
            <option value="3">Group 3</option>
            <option value="4">Group 4</option>
            <option value="5">Group 5</option>
            <option value="6">Group 6</option>
            <option value="7">Group 7</option>
        </select>
        <input type="number" id="nodeSize" placeholder="Node Size" min="1" max="50">
        <select id="nodeShape">
            <option value="circle">Circle</option>
            <option value="square">Square</option>
            <option value="triangle">Triangle</option>
        </select>
        <button id="editNodeJson">Edit Node JSON</button>
        <button id="saveNode">Save Node</button>
        <button id="cancelEdit">Cancel</button>
    </div>
    <div id="linkForm" style="display: none;">
        <select id="sourceNode"></select>
        <select id="targetNode"></select>
        <input type="text" id="linkName" placeholder="Link Name">
        <textarea id="linkDescription" placeholder="Link Description"></textarea>
        <input type="color" id="linkColor" value="#999999">
        <button id="saveLink">Save Link</button>
        <button id="cancelLink">Cancel</button>
    </div>
    <div id="removeNodeForm" style="display: none;">
        <select id="nodeToRemove"></select>
        <button id="confirmRemoveNode">Remove</button>
        <button id="cancelRemoveNode">Cancel</button>
    </div>
    <div id="removeLinkForm" style="display: none;">
        <select id="linkToRemove"></select>
        <button id="confirmRemoveLink">Remove</button>
        <button id="cancelRemoveLink">Cancel</button>
    </div>
    <div id="editLinkForm" style="display: none;">
        <input type="text" id="editLinkName" placeholder="Link Name">
        <textarea id="editLinkDescription" placeholder="Link Description"></textarea>
        <input type="color" id="editLinkColor" value="#999999">
        <button id="saveLinkChanges">Save Changes</button>
        <button id="cancelLinkEdit">Cancel</button>
    </div>
    <div id="diagram"></div>
    <div id="miniMap"></div>
    <div id="statusBar"></div>
    <div id="nodeList">
        <div class="closeButton">&times;</div>
    </div>
    <div id="linkListWindow">
        <div class="closeButton">&times;</div>
        <div id="linkListContent"></div>
    </div>
    <div id="nodeEditWindow">
        <input type="text" id="editNodeName" placeholder="Node Name">
        <textarea id="editNodeDescription" placeholder="Node Description"></textarea>
        <input type="color" id="editNodeColor">
        <input type="number" id="editNodeSize" placeholder="Node Size" min="1" max="50">
        <select id="editNodeShape">
            <option value="circle">Circle</option>
            <option value="square">Square</option>
            <option value="triangle">Triangle</option>
        </select>
        <button id="editNodeJsonFromProperties">Edit Node JSON</button>
        <button id="saveNodeChanges">Save Changes</button>
        <button id="cancelNodeEdit">Cancel</button>
    </div>
    <div id="consoleWindow">
        <div class="closeButton">&times;</div>
        <input type="text" id="consoleInput" placeholder="Enter command">
        <button id="runCommand">Run Command</button>
    </div>
    <div id="nodeInfoWindow">
        <div class="closeButton">&times;</div>
        <pre id="nodeInfoContent"></pre>
    </div>
    <div id="nodesListWindow">
        <div class="closeButton">&times;</div>
        <pre id="nodesListContent"></pre>
    </div>
    <div id="historyWindow">
        <div class="closeButton">&times;</div>
        <pre id="historyContent"></pre>
        <button id="clearHistory">Clear History</button>
    </div>
    <div id="jsonSchemaWindow">
        <div class="closeButton">&times;</div>
        <textarea id="jsonInput" placeholder="Enter JSON here"></textarea>
        <button id="getNodeJson">Get JSON of Node</button>
        <button id="transformJson">Transform</button>
        <textarea id="jsonOutput" readonly></textarea>
    </div>
    <div id="editNodeJsonWindow">
        <div class="closeButton">&times;</div>
        <div id="currentNodeName"></div>
        <textarea id="editNodeJsonContent"></textarea>
        <button id="saveNodeJsonChanges">Save Changes</button>
    </div>
    <a id="docs" href="https://ad.js/docs" target="_blank">Docs</a>
    <script>
        const width = document.getElementById('diagram').clientWidth;
        const height = document.getElementById('diagram').clientHeight;

        const svg = d3.select("#diagram")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g");

        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
                updateMiniMap();
            });

        svg.call(zoom);

        let simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2));

        let data = {
            nodes: [],
            links: []
        };

        let link = g.append("g")
            .attr("class", "links")
            .selectAll("line");

        let node = g.append("g")
            .attr("class", "nodes")
            .selectAll(".node");

        let label = g.append("g")
            .attr("class", "labels")
            .selectAll("text");

        let showLabels = true;
        let history = [];

        function updateSimulation() {
            link = link.data(data.links, d => `${d.source.id}-${d.target.id}`);
            link.exit().remove();
            link = link.enter().append("line")
                .attr("class", "link")
                .on("click", showLinkTooltip)
                .merge(link);

            node = node.data(data.nodes, d => d.id);
            node.exit().remove();
            node = node.enter().append("g")
                .attr("class", "node")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended))
                .on("dblclick", editNode)
                .merge(node);

            node.selectAll("*").remove();
            node.each(function(d) {
                const shape = d3.select(this);
                if (d.shape === "circle") {
                    shape.append("circle")
                        .attr("r", d => d.size)
                        .attr("fill", d => d.color);
                } else if (d.shape === "square") {
                    shape.append("rect")
                        .attr("width", d => d.size * 2)
                        .attr("height", d => d.size * 2)
                        .attr("x", d => -d.size)
                        .attr("y", d => -d.size)
                        .attr("fill", d => d.color);
                } else if (d.shape === "triangle") {
                    const triangleSize = d => d.size * 1.5;
                    shape.append("polygon")
                        .attr("points", d => `0,-${triangleSize(d)} ${triangleSize(d)},${triangleSize(d)} -${triangleSize(d)},${triangleSize(d)}`)
                        .attr("fill", d => d.color);
                }
            });

            label = label.data(data.nodes, d => d.id);
            label.exit().remove();
            label = label.enter().append("text")
                .attr("dx", 12)
                .attr("dy", ".35em")
                .merge(label)
                .text(d => d.id);

            label.style("display", showLabels ? "block" : "none");

            simulation.nodes(data.nodes);
            simulation.force("link").links(data.links);
            simulation.alpha(1).restart();

            updateStatusBar();
            addNodeTooltip();
            updateMiniMap();
            addToHistory("Updated simulation");
        }

        function ticked() {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y)
                .attr("stroke", d => d.color || "#999");

            node
                .attr("transform", d => `translate(${d.x},${d.y})`);

            label
                .attr("x", d => d.x)
                .attr("y", d => d.y);

            updateMiniMap();
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;

            checkAndCreateLinks(d);
        }

        function checkAndCreateLinks(d) {
            const threshold = 50;
            data.nodes.forEach(otherNode => {
                if (otherNode !== d) {
                    const dx = d.x - otherNode.x;
                    const dy = d.y - otherNode.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < threshold) {
                        const linkExists = data.links.some(link => 
                            (link.source === d && link.target === otherNode) ||
                            (link.source === otherNode && link.target === d)
                        );
                        if (!linkExists) {
                            const newLink = {
                                source: d,
                                target: otherNode,
                                name: `Link ${data.links.length + 1}`,
                                description: "Auto-generated link",
                                color: "#999999"
                            };
                            data.links.push(newLink);
                            updateSimulation();
                            addToHistory(`Created link between ${d.id} and ${otherNode.id}`);
                        }
                    }
                }
            });
        }

        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        function addNodeTooltip() {
            node.on("mouseover", function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(d.description)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function(d) {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            });
        }

        function showLinkTooltip(event, d) {
            tooltip.transition()
                .duration(200)
                .style("opacity", .9);
            tooltip.html(d.description)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 28) + "px");
        }

        function addNode() {
            const newNodeId = "Custom " + (data.nodes.length + 1);
            data.nodes.push({id: newNodeId, group: 7, description: "Custom node", color: "#17becf", size: 10, shape: "circle"});
            updateSimulation();
            addToHistory(`Added new node: ${newNodeId}`);
        }

        function removeNode() {
            const removeNodeForm = document.getElementById('removeNodeForm');
            removeNodeForm.style.display = 'block';
            
            const nodeSelect = document.getElementById('nodeToRemove');
            nodeSelect.innerHTML = '';
            
            data.nodes.forEach(node => {
                nodeSelect.add(new Option(node.id, node.id));
            });
        }

        function confirmRemoveNode() {
            const nodeId = document.getElementById('nodeToRemove').value;
            data.nodes = data.nodes.filter(node => node.id !== nodeId);
            data.links = data.links.filter(link => 
                link.source.id !== nodeId && link.target.id !== nodeId
            );
            updateSimulation();
            document.getElementById('removeNodeForm').style.display = 'none';
            addToHistory(`Removed node: ${nodeId}`);
        }

        function addLink() {
            const linkForm = document.getElementById('linkForm');
            linkForm.style.display = 'block';
            
            const sourceSelect = document.getElementById('sourceNode');
            const targetSelect = document.getElementById('targetNode');
            
            sourceSelect.innerHTML = '';
            targetSelect.innerHTML = '';
            
            data.nodes.forEach(node => {
                sourceSelect.add(new Option(node.id, node.id));
                targetSelect.add(new Option(node.id, node.id));
            });
        }

        function removeLink() {
            const removeLinkForm = document.getElementById('removeLinkForm');
            removeLinkForm.style.display = 'block';
            
            const linkSelect = document.getElementById('linkToRemove');
            linkSelect.innerHTML = '';
            
            data.links.forEach((link, index) => {
                linkSelect.add(new Option(`${link.name}: ${link.source.id} - ${link.target.id}`, index));
            });
        }

        function confirmRemoveLink() {
            const linkIndex = parseInt(document.getElementById('linkToRemove').value);
            const removedLink = data.links[linkIndex];
            data.links.splice(linkIndex, 1);
            updateSimulation();
            document.getElementById('removeLinkForm').style.display = 'none';
            addToHistory(`Removed link: ${removedLink.name}`);
        }

        function resetLayout() {
            simulation.alpha(1).restart();
            addToHistory("Reset layout");
        }

        function resetView() {
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity,
                d3.zoomTransform(svg.node()).invert([width / 2, height / 2])
            );
            addToHistory("Reset view");
        }

        function editNode(event, d) {
            const form = document.getElementById('editForm');
            form.style.display = 'block';
            document.getElementById('nodeId').value = d.id;
            document.getElementById('nodeGroup').value = d.group;
            document.getElementById('nodeSize').value = d.size;
            document.getElementById('nodeShape').value = d.shape;

            document.getElementById('editNodeJson').onclick = function() {
                openEditNodeJsonWindow(d);
            };

            document.getElementById('saveNode').onclick = function() {
                const newId = document.getElementById('nodeId').value;
                const newGroup = parseInt(document.getElementById('nodeGroup').value);
                const newSize = parseInt(document.getElementById('nodeSize').value);
                const newShape = document.getElementById('nodeShape').value;
                const oldId = d.id;
                d.id = newId;
                d.group = newGroup;
                d.size = newSize;
                d.shape = newShape;
                updateSimulation();
                form.style.display = 'none';
                addToHistory(`Edited node: ${oldId} -> ${newId}`);
            };

            document.getElementById('cancelEdit').onclick = function() {
                form.style.display = 'none';
            };
        }

        function editLink(event, d) {
            const form = document.getElementById('editLinkForm');
            form.style.display = 'block';
            document.getElementById('editLinkName').value = d.name || '';
            document.getElementById('editLinkDescription').value = d.description || '';
            document.getElementById('editLinkColor').value = d.color || "#999999";

            document.getElementById('saveLinkChanges').onclick = function() {
                d.name = document.getElementById('editLinkName').value;
                d.description = document.getElementById('editLinkDescription').value;
                d.color = document.getElementById('editLinkColor').value;
                updateSimulation();
                form.style.display = 'none';
                addToHistory(`Edited link: ${d.name}`);
            };

            document.getElementById('cancelLinkEdit').onclick = function() {
                form.style.display = 'none';
            };
        }

        function toggleLabels() {
            showLabels = !showLabels;
            label.style("display", showLabels ? "block" : "none");
            addToHistory(showLabels ? "Showed labels" : "Hid labels");
        }

        function updateStatusBar() {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = `Nodes: ${data.nodes.length}, Links: ${data.links.length}`;
        }

        function showNodeList() {
            const nodeList = document.getElementById('nodeList');
            nodeList.innerHTML = '<div class="closeButton">&times;</div>';
            nodeList.style.display = 'block';

            data.nodes.forEach(node => {
                const listItem = document.createElement('div');
                listItem.className = 'nodeListItem';
                
                const colorPreview = document.createElement('div');
                colorPreview.className = 'nodeColorPreview';
                colorPreview.style.backgroundColor = node.color;
                
                const nodeInfo = document.createElement('span');
                nodeInfo.textContent = `${node.id} (Size: ${node.size}, Shape: ${node.shape})`;
                
                listItem.appendChild(colorPreview);
                listItem.appendChild(nodeInfo);
                
                listItem.addEventListener('click', () => openNodeEditWindow(node));
                
                nodeList.appendChild(listItem);
            });

            document.querySelector('#nodeList .closeButton').addEventListener('click', () => {
                nodeList.style.display = 'none';
            });

            addToHistory("Showed node list");
        }

        function showLinkList() {
            const linkListWindow = document.getElementById('linkListWindow');
            const linkListContent = document.getElementById('linkListContent');
            linkListContent.innerHTML = '';
            linkListWindow.style.display = 'block';

            data.links.forEach(link => {
                const listItem = document.createElement('div');
                listItem.className = 'linkListItem';
                
                const colorPreview = document.createElement('div');
                colorPreview.className = 'linkColorPreview';
                colorPreview.style.backgroundColor = link.color || "#999999";
                
                const linkInfo = document.createElement('span');
                linkInfo.textContent = `${link.name || 'Unnamed'}: ${link.source.id} - ${link.target.id}`;
                
                listItem.appendChild(colorPreview);
                listItem.appendChild(linkInfo);
                
                listItem.addEventListener('click', () => editLink(null, link));
                
                linkListContent.appendChild(listItem);
            });

            addToHistory("Showed link list");
        }

        function openNodeEditWindow(node) {
            const editWindow = document.getElementById('nodeEditWindow');
            editWindow.style.display = 'block';
            
            document.getElementById('editNodeName').value = node.id;
            document.getElementById('editNodeDescription').value = node.description;
            document.getElementById('editNodeColor').value = node.color;
            document.getElementById('editNodeSize').value = node.size;
            document.getElementById('editNodeShape').value = node.shape;
            
            document.getElementById('editNodeJsonFromProperties').onclick = function() {
                openEditNodeJsonWindow(node);
            };
            
            document.getElementById('saveNodeChanges').onclick = function() {
                const newId = document.getElementById('editNodeName').value;
                const oldId = node.id;
                node.id = newId;
                node.description = document.getElementById('editNodeDescription').value;
                node.color = document.getElementById('editNodeColor').value;
                node.size = parseInt(document.getElementById('editNodeSize').value);
                node.shape = document.getElementById('editNodeShape').value;
                
                // Update links
                data.links.forEach(link => {
                    if (link.source.id === oldId) link.source = node;
                    if (link.target.id === oldId) link.target = node;
                });
                
                updateSimulation();
                editWindow.style.display = 'none';
                showNodeList(); // Refresh the node list
                addToHistory(`Edited node: ${oldId} -> ${newId}`);
            };
            
            document.getElementById('cancelNodeEdit').onclick = function() {
                editWindow.style.display = 'none';
            };
        }

        function exportImage() {
            html2canvas(document.getElementById('diagram')).then(function(canvas) {
                const link = document.createElement('a');
                link.download = 'diagram.png';
                link.href = canvas.toDataURL();
                link.click();
                addToHistory("Exported diagram as image");
            });
        }

        function openConsole() {
            document.getElementById('consoleWindow').style.display = 'block';
        }

        function runCommand() {
            const command = document.getElementById('consoleInput').value;
            if (command.startsWith('getnodeinfo(')) {
                const nodeNames = command.slice(12, -1).split(',').map(name => name.trim());
                const nodeInfo = nodeNames.map(name => {
                    const node = data.nodes.find(n => n.id === name);
                    return node ? JSON.stringify(node, null, 2) : `Node "${name}" not found`;
                }).join('\n\n');
                
                const nodeInfoWindow = document.getElementById('nodeInfoWindow');
                document.getElementById('nodeInfoContent').textContent = nodeInfo;
                nodeInfoWindow.style.display = 'block';
                addToHistory(`Executed command: ${command}`);
            } else if (command === 'getNodesList') {
                const nodesListWindow = document.getElementById('nodesListWindow');
                document.getElementById('nodesListContent').textContent = JSON.stringify(data.nodes, null, 2);
                nodesListWindow.style.display = 'block';
                addToHistory(`Executed command: ${command}`);
            } else if (command.startsWith('changeNodeColor(')) {
                const params = command.slice(16, -1).split(',').map(param => param.trim());
                const nodeId = params[0];
                const newColor = params[1];
                const node = data.nodes.find(n => n.id === nodeId);
                if (node) {
                    node.color = newColor;
                    updateSimulation();
                    addToHistory(`Changed color of node ${nodeId} to ${newColor}`);
                } else {
                    alert(`Node "${nodeId}" not found`);
                }
            } else if (command === 'jsonschgen') {
                openJsonSchemaWindow();
                addToHistory(`Executed command: ${command}`);
            } else if (command === 'editnodejson') {
                openEditNodeJsonSelection();
                addToHistory(`Executed command: ${command}`);
            } else {
                alert('Unknown command. Try getnodeinfo(node1, node2, ...), getNodesList, changeNodeColor(nodeId, newColor), jsonschgen, or editnodejson');
            }
        }

        function addToHistory(action) {
            const timestamp = new Date().toLocaleString();
            history.push(`[${timestamp}] ${action}`);
        }

        function showHistory() {
            const historyWindow = document.getElementById('historyWindow');
            document.getElementById('historyContent').textContent = history.join('\n');
            historyWindow.style.display = 'block';
        }

        function clearHistory() {
            history = [];
            document.getElementById('historyContent').textContent = '';
            addToHistory('Cleared history');
        }

        function updateMiniMap() {
            const miniMap = d3.select("#miniMap");
            miniMap.selectAll("*").remove();

            const miniSvg = miniMap.append("svg")
                .attr("width", "100%")
                .attr("height", "100%");

            const miniG = miniSvg.append("g");

            const xExtent = d3.extent(data.nodes, d => d.x);
            const yExtent = d3.extent(data.nodes, d => d.y);

            const xScale = d3.scaleLinear()
                .domain(xExtent)
                .range([0, 200]);

            const yScale = d3.scaleLinear()
                .domain(yExtent)
                .range([0, 150]);

            miniG.selectAll("line")
                .data(data.links)
                .enter()
                .append("line")
                .attr("x1", d => xScale(d.source.x))
                .attr("y1", d => yScale(d.source.y))
                .attr("x2", d => xScale(d.target.x))
                .attr("y2", d => yScale(d.target.y))
                .attr("stroke", d => d.color || "#999")
                .attr("stroke-width", 1);

            miniG.selectAll(".miniNode")
                .data(data.nodes)
                .enter()
                .append("g")
                .attr("class", "miniNode")
                .attr("transform", d => `translate(${xScale(d.x)},${yScale(d.y)})`)
                .each(function(d) {
                    const shape = d3.select(this);
                    if (d.shape === "circle") {
                        shape.append("circle")
                            .attr("r", 2)
                            .attr("fill", d.color);
                    } else if (d.shape === "square") {
                        shape.append("rect")
                            .attr("width", 4)
                            .attr("height", 4)
                            .attr("x", -2)
                            .attr("y", -2)
                            .attr("fill", d.color);
                    } else if (d.shape === "triangle") {
                        shape.append("polygon")
                            .attr("points", "0,-2 2,2 -2,2")
                            .attr("fill", d.color);
                    }
                });
        }

        function toggleMiniMap() {
            const miniMap = document.getElementById('miniMap');
            miniMap.style.display = miniMap.style.display === 'none' ? 'block' : 'none';
            addToHistory(miniMap.style.display === 'none' ? "Hid mini-map" : "Showed mini-map");
        }

        function searchNode() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const foundNode = data.nodes.find(node => node.id.toLowerCase().includes(searchTerm));
            if (foundNode) {
                const transform = d3.zoomIdentity
                    .translate(width / 2, height / 2)
                    .scale(1)
                    .translate(-foundNode.x, -foundNode.y);
                
                svg.transition().duration(750).call(zoom.transform, transform);
                addToHistory(`Found and centered on node: ${foundNode.id}`);
            } else {
                alert(`Node containing "${searchTerm}" not found`);
            }
        }

        function openJsonSchemaWindow() {
            const jsonSchemaWindow = document.getElementById('jsonSchemaWindow');
            jsonSchemaWindow.style.display = 'block';
        }

        function getNodeJson() {
            const nodeListWindow = document.createElement('div');
            nodeListWindow.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:white;border:1px solid #ccc;border-radius:5px;padding:20px;max-height:80vh;overflow-y:auto;z-index:1002;';
            document.body.appendChild(nodeListWindow);

            const closeButton = document.createElement('div');
            closeButton.innerHTML = '&times;';
            closeButton.style.cssText = 'position:absolute;top:10px;right:10px;cursor:pointer;font-size:20px;color:#999;';
            closeButton.onclick = () => document.body.removeChild(nodeListWindow);
            nodeListWindow.appendChild(closeButton);

            data.nodes.forEach(node => {
                const nodeButton = document.createElement('button');
                nodeButton.textContent = node.id;
                nodeButton.onclick = () => {
                    document.getElementById('jsonInput').value = JSON.stringify(node, null, 2);
                    document.body.removeChild(nodeListWindow);
                };
                nodeListWindow.appendChild(nodeButton);
            });
        }

        function transformJson() {
            try {
                const inputJson = JSON.parse(document.getElementById('jsonInput').value);
                const schema = generateJsonSchema(inputJson);
                document.getElementById('jsonOutput').value = JSON.stringify(schema, null, 2);
            } catch (error) {
                alert('Invalid JSON input: ' + error.message);
            }
        }

        function generateJsonSchema(obj) {
            const schema = {
                type: 'object',
                properties: {}
            };

            for (const [key, value] of Object.entries(obj)) {
                schema.properties[key] = getPropertySchema(value);
            }

            return schema;
        }

        function getPropertySchema(value) {
            if (Array.isArray(value)) {
                return {
                    type: 'array',
                    items: value.length > 0 ? getPropertySchema(value[0]) : {}
                };
            } else if (typeof value === 'object' && value !== null) {
                return generateJsonSchema(value);
            } else {
                return { type: typeof value };
            }
        }

        function openEditNodeJsonSelection() {
            const nodeListWindow = document.createElement('div');
            nodeListWindow.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:white;border:1px solid #ccc;border-radius:5px;padding:20px;max-height:80vh;overflow-y:auto;z-index:1002;';
            document.body.appendChild(nodeListWindow);

            const closeButton = document.createElement('div');
            closeButton.innerHTML = '&times;';
            closeButton.style.cssText = 'position:absolute;top:10px;right:10px;cursor:pointer;font-size:20px;color:#999;';
            closeButton.onclick = () => document.body.removeChild(nodeListWindow);
            nodeListWindow.appendChild(closeButton);

            data.nodes.forEach(node => {
                const nodeButton = document.createElement('div');
                nodeButton.style.cssText = 'display:flex;align-items:center;margin-bottom:10px;cursor:pointer;';
                nodeButton.innerHTML = `
                    <div style="width:20px;height:20px;border-radius:50%;background-color:${node.color};margin-right:10px;"></div>
                    <span>${node.id}</span>
                `;
                nodeButton.onclick = () => {
                    document.body.removeChild(nodeListWindow);
                    openEditNodeJsonWindow(node);
                };
                nodeListWindow.appendChild(nodeButton);
            });
        }

        function openEditNodeJsonWindow(node) {
            const editNodeJsonWindow = document.getElementById('editNodeJsonWindow');
            editNodeJsonWindow.style.display = 'block';
            document.getElementById('currentNodeName').textContent = `Editing: ${node.id}`;
            document.getElementById('editNodeJsonContent').value = JSON.stringify(node, null, 2);
        }

        function saveNodeJsonChanges() {
            try {
                const editedNode = JSON.parse(document.getElementById('editNodeJsonContent').value);
                const index = data.nodes.findIndex(node => node.id === editedNode.id);
                if (index !== -1) {
                    // Preserve links
                    const oldNode = data.nodes[index];
                    data.links.forEach(link => {
                        if (link.source === oldNode) link.source = editedNode;
                        if (link.target === oldNode) link.target = editedNode;
                    });
                    
                    data.nodes[index] = editedNode;
                    updateSimulation();
                    document.getElementById('editNodeJsonWindow').style.display = 'none';
                    addToHistory(`Edited node JSON: ${editedNode.id}`);
                } else {
                    alert('Node not found in the data');
                }
            } catch (error) {
                alert('Invalid JSON: ' + error.message);
            }
        }

        document.getElementById("addNode").addEventListener("click", addNode);
        document.getElementById("removeNode").addEventListener("click", removeNode);
        document.getElementById("addLink").addEventListener("click", addLink);
        document.getElementById("removeLink").addEventListener("click", removeLink);
        document.getElementById("resetLayout").addEventListener("click", resetLayout);
        document.getElementById("resetView").addEventListener("click", resetView);
        document.getElementById("toggleLabels").addEventListener("click", toggleLabels);
        document.getElementById("showNodeList").addEventListener("click", showNodeList);
        document.getElementById("showLinkList").addEventListener("click", showLinkList);
        document.getElementById("exportImage").addEventListener("click", exportImage);
        document.getElementById("openConsole").addEventListener("click", openConsole);
        document.getElementById("runCommand").addEventListener("click", runCommand);
        document.getElementById("showHistory").addEventListener("click", showHistory);
        document.getElementById("toggleMiniMap").addEventListener("click", toggleMiniMap);
        document.getElementById("clearHistory").addEventListener("click", clearHistory);
        document.getElementById("searchButton").addEventListener("click", searchNode);
        document.getElementById("getNodeJson").addEventListener("click", getNodeJson);
        document.getElementById("transformJson").addEventListener("click", transformJson);
        document.getElementById("saveNodeJsonChanges").addEventListener("click", saveNodeJsonChanges);

        document.getElementById('saveLink').addEventListener('click', function() {
            const source = document.getElementById('sourceNode').value;
            const target = document.getElementById('targetNode').value;
            const name = document.getElementById('linkName').value;
            const description = document.getElementById('linkDescription').value;
            const color = document.getElementById('linkColor').value;
            if (source !== target) {
                data.links.push({
                    source: source,
                    target: target,
                    name: name,
                    description: description,
                    color: color
                });
                updateSimulation();
                addToHistory(`Added link: ${name} (${source} - ${target})`);
            }
            document.getElementById('linkForm').style.display = 'none';
        });

        document.getElementById('cancelLink').addEventListener('click', function() {
            document.getElementById('linkForm').style.display = 'none';
        });

        document.getElementById('confirmRemoveNode').addEventListener('click', confirmRemoveNode);
        document.getElementById('cancelRemoveNode').addEventListener('click', function() {
            document.getElementById('removeNodeForm').style.display = 'none';
        });

        document.getElementById('confirmRemoveLink').addEventListener('click', confirmRemoveLink);
        document.getElementById('cancelRemoveLink').addEventListener('click', function() {
            document.getElementById('removeLinkForm').style.display = 'none';
        });

        document.querySelectorAll('.closeButton').forEach(button => {
            button.addEventListener('click', function() {
                this.closest('div[id$="Window"]').style.display = 'none';
            });
        });

        updateSimulation();

        simulation.on("tick", ticked);
    </script>
</body>
</html>